<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Viral Reel Automator - Dashboard</title>
    <style>
      body {
        background-color: #0f172a;
        color: #f1f5f9;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, "Noto Sans JP", sans-serif;
        padding: 32px;
        margin: 0;
      }

      h1 {
        font-size: 28px;
        font-weight: 800;
        margin-bottom: 24px;
      }

      label {
        display: block;
        margin: 16px 0 8px;
      }

      input[type="text"],
      input[type="number"] {
        width: 100%;
        max-width: 480px;
        padding: 10px;
        font-size: 16px;
        border: none;
        border-radius: 8px;
        margin-bottom: 12px;
      }

      button {
        background-color: #ec4899;
        border: none;
        padding: 12px 20px;
        border-radius: 8px;
        color: white;
        font-weight: bold;
        font-size: 16px;
        cursor: pointer;
        margin-top: 12px;
      }

      #result {
        margin-top: 40px;
      }

      .video-card {
        background: #1e293b;
        padding: 16px;
        border-radius: 12px;
        margin-bottom: 16px;
      }

      .video-card p {
        margin: 4px 0;
      }

      a.download-link {
        display: inline-block;
        margin-top: 8px;
        color: #93c5fd;
        text-decoration: underline;
      }
    </style>
  </head>

  <body>
    <h1>🎬 Viral Reel Automator Dashboard</h1>

    <div id="userInfo">ログイン状態を確認中...</div>

    <div id="mainApp" style="display:none;">
      <label>キーワードでアカウントを探す</label>
      <input type="text" id="keyword" placeholder="例: memes, fitness, cat" />

      <button onclick="sendKeyword()">🔍 リサーチ開始</button>

      <label>スクレイピングするアカウントをカンマ区切りで入力</label>
      <input type="text" id="accounts" placeholder="例: memezone, dailyfunnyclips" />

      <label>スクレイプする動画数（最大10）</label>
      <input type="number" id="limit" min="1" max="10" value="5" />

      <button onclick="scrapeVideos()">📥 動画を取得する</button>

      <div id="result"></div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBF3Ux_IZk6PU3thCwlZtDqBcXBkJWPj-8",
        authDomain: "viral-reel-automator.firebaseapp.com",
        projectId: "viral-reel-automator",
        storageBucket: "viral-reel-automator.appspot.com",
        messagingSenderId: "149388169567",
        appId: "1:149388169567:web:0dfe6f214d09d5c9c9a6ea",
        measurementId: "G-8N6L9GDKNC"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          window.location.href = "/"; // not logged in
          return;
        }

        const uid = user.uid;
        const userRef = doc(db, "users", uid);
        const userSnap = await getDoc(userRef);

        if (!userSnap.exists()) {
          window.location.href = "/pricing.html"; // no linked payment
          return;
        }

        const email = user.email;
        document.getElementById("userInfo").innerText = `ログイン中: ${email}`;
        document.getElementById("mainApp").style.display = "block";
      });

      async function sendKeyword() {
        const keyword = document.getElementById("keyword").value.trim();
        if (!keyword) return alert("キーワードを入力してください");

        const res = await fetch("https://hook.us1.make.com/xxxx", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ keyword })
        });

        if (!res.ok) return alert("エラーが発生しました");
        alert("リサーチを開始しました。数分後にアカウントが表示されます。");
      }

      async function scrapeVideos() {
        const accounts = document.getElementById("accounts").value.trim();
        const limit = parseInt(document.getElementById("limit").value);

        if (!accounts || isNaN(limit)) {
          return alert("全ての項目を入力してください");
        }

        const res = await fetch("https://hook.us1.make.com/yyyy", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ accounts, limit })
        });

        if (!res.ok) return alert("スクレイプに失敗しました");

        const data = await res.json();
        displayResults(data);
      }

      function displayResults(data) {
        const container = document.getElementById("result");
        container.innerHTML = "";

        data.videos.forEach(video => {
          const card = document.createElement("div");
          card.className = "video-card";

          card.innerHTML = `
            <p><strong>タイトル:</strong> ${video.title}</p>
            <p><strong>再生数:</strong> ${video.views}</p>
            <p><strong>投稿日:</strong> ${video.date}</p>
            <a class="download-link" href="${video.downloadUrl}" download>⬇️ ダウンロード</a>
          `;

          container.appendChild(card);
        });
      }
    </script>
  </body>
</html>
