<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Viral Reel Automator - Dashboard</title>
    <style>
      body {
        background-color: #0f172a;
        color: #f1f5f9;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, "Noto Sans JP", sans-serif;
        padding: 32px;
        margin: 0;
      }

      h1 {
        font-size: 28px;
        font-weight: 800;
        margin-bottom: 24px;
      }

      label {
        display: block;
        margin: 16px 0 8px;
      }

      input[type="text"],
      input[type="number"] {
        width: 100%;
        max-width: 480px;
        padding: 10px;
        font-size: 16px;
        border: none;
        border-radius: 8px;
        margin-bottom: 12px;
      }

      button {
        background-color: #ec4899;
        border: none;
        padding: 12px 20px;
        border-radius: 8px;
        color: white;
        font-weight: bold;
        font-size: 16px;
        cursor: pointer;
        margin-top: 12px;
      }

      #result {
        margin-top: 40px;
      }

      .video-card {
        background: #1e293b;
        padding: 16px;
        border-radius: 12px;
        margin-bottom: 16px;
      }

      .video-card p {
        margin: 4px 0;
      }

      a.download-link {
        display: inline-block;
        margin-top: 8px;
        color: #93c5fd;
        text-decoration: underline;
      }
    </style>
  </head>

  <body>
    <h1>ğŸ¬ Viral Reel Automator Dashboard</h1>

    <div id="userInfo">ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ç¢ºèªä¸­...</div>

    <div id="mainApp" style="display:none;">
      <label>ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’æ¢ã™</label>
      <input type="text" id="keyword" placeholder="ä¾‹: memes, fitness, cat" />

      <button onclick="sendKeyword()">ğŸ” ãƒªã‚µãƒ¼ãƒé–‹å§‹</button>

      <label>ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã™ã‚‹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥åŠ›</label>
      <input type="text" id="accounts" placeholder="ä¾‹: memezone, dailyfunnyclips" />

      <label>ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ—ã™ã‚‹å‹•ç”»æ•°ï¼ˆæœ€å¤§10ï¼‰</label>
      <input type="number" id="limit" min="1" max="10" value="5" />

      <button onclick="scrapeVideos()">ğŸ“¥ å‹•ç”»ã‚’å–å¾—ã™ã‚‹</button>

      <div id="result"></div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBF3Ux_IZk6PU3thCwlZtDqBcXBkJWPj-8",
        authDomain: "viral-reel-automator.firebaseapp.com",
        projectId: "viral-reel-automator",
        storageBucket: "viral-reel-automator.appspot.com",
        messagingSenderId: "149388169567",
        appId: "1:149388169567:web:0dfe6f214d09d5c9c9a6ea",
        measurementId: "G-8N6L9GDKNC"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          window.location.href = "/"; // not logged in
          return;
        }

        const uid = user.uid;
        const userRef = doc(db, "users", uid);
        const userSnap = await getDoc(userRef);

        if (!userSnap.exists()) {
          window.location.href = "/pricing.html"; // no linked payment
          return;
        }

        const email = user.email;
        document.getElementById("userInfo").innerText = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­: ${email}`;
        document.getElementById("mainApp").style.display = "block";
      });

      async function sendKeyword() {
        const keyword = document.getElementById("keyword").value.trim();
        if (!keyword) return alert("ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

        const res = await fetch("https://hook.us1.make.com/xxxx", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ keyword })
        });

        if (!res.ok) return alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
        alert("ãƒªã‚µãƒ¼ãƒã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚æ•°åˆ†å¾Œã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚");
      }

      async function scrapeVideos() {
        const accounts = document.getElementById("accounts").value.trim();
        const limit = parseInt(document.getElementById("limit").value);

        if (!accounts || isNaN(limit)) {
          return alert("å…¨ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        }

        const res = await fetch("https://hook.us1.make.com/yyyy", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ accounts, limit })
        });

        if (!res.ok) return alert("ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸ");

        const data = await res.json();
        displayResults(data);
      }

      function displayResults(data) {
        const container = document.getElementById("result");
        container.innerHTML = "";

        data.videos.forEach(video => {
          const card = document.createElement("div");
          card.className = "video-card";

          card.innerHTML = `
            <p><strong>ã‚¿ã‚¤ãƒˆãƒ«:</strong> ${video.title}</p>
            <p><strong>å†ç”Ÿæ•°:</strong> ${video.views}</p>
            <p><strong>æŠ•ç¨¿æ—¥:</strong> ${video.date}</p>
            <a class="download-link" href="${video.downloadUrl}" download>â¬‡ï¸ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</a>
          `;

          container.appendChild(card);
        });
      }
    </script>
  </body>
</html>
